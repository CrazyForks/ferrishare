{% extends "base.html" %}

{% block title -%}
Upload a File - E2EE Fileshare
{%- endblock %}

{% block content %}
<div class="m-8">
  <div class="max-w-lg lg:max-w-6xl lg:shadow-lg lg:bg-gray-100 lg:rounded-xl flex flex-col lg:p-8 gap-8 mx-auto">
    <div class="flex items-stretch">
      <h2 class="flex gap-4 text-2xl items-center justify-center lg:justify-start mr-4">
        <span class="matsym text-3xl">home_storage</span>
        Viewing All Uploaded Files
      </h2>
      <form method="post" action="/admin_logout" class="ml-auto flex items-center">
        <button type="submit" class="flex items-center justify-center gap-2 py-2 px-4 rounded-full bg-gray-300 font-bold cursor-pointer shadow-sm hover:shadow-md active:shadow-sm">
          <span>Logout</span>
          <span class="matsym">logout</span>
        </button>
      </form>
    </div>
    {% if files %}
    <table>
      <thead>
        <tr class="hidden lg:table-row text-left *:font-bold *:p-4 text-gray-500">
          <th class=""> File Hash </th>
          <th class=""> Size </th>
          <th class=""> Uploaded </th>
          <th class=""> Expires in </th>
          <!-- <th class=""> <span class="matsym">visibility</span> </th> -->
          <th class=""> <span class="matsym">download</span> </th>
          <th class=""> <span class="matsym">delete</span> </th>
        </tr>
      </thead>
      <tbody class="lg:table-row-group flex flex-col gap-8">
        {% for file in files %}
        <tr
          class="flex lg:table-row flex-col lg:*:p-4 gap-6 lg:border-t-2 lg:border-gray-200 rounded-xl bg-gray-100 lg:bg-inherit shadow-lg lg:shadow-none p-8 lg:p-0">
          <td class="flex lg:table-cell flex-row gap-4">
            <div class="lg:hidden matsym text-2xl text-gray-500">code</div>
            <div class="flex flex-col">
              <div class="lg:hidden text-gray-500">File Hash</div>
              <div class="text-base lg:text-sm font-mono break-all max-w-[22ch]">{{ file.efd_sha256sum }}</div>
            </div>
          </td>
          <td class="flex lg:table-cell flex-row gap-4">
            <div class="lg:hidden matsym text-2xl text-gray-500">clock_loader_90</div>
            <div class="flex flex-col">
              <div class="lg:hidden text-gray-500">Size</div>
              <div class="text-xl lg:text-lg">{{ file.formatted_filesize }}</div>
            </div>
          </td>
          <td class="flex lg:table-cell flex-row gap-4">
            <div class="lg:hidden matsym text-2xl text-gray-500">note_add</div>
            <div class="flex flex-col">
              <div class="lg:hidden text-gray-500">Uploaded</div>
              <div class="flex lg:flex-col gap-2 lg:gap-0 items-baseline text-xl lg:text-lg">
                <div class="text-xl lg:text-lg">
                  {{ file.upload_ts_pretty }}
                </div>
                <div class="text-gray-500 text-sm">
                  {{ file.upload_ts }}
                </div>
              </div>
            </div>
          </td>
          <td class="flex lg:table-cell flex-row gap-4">
            <div class="lg:hidden matsym text-2xl text-gray-500">auto_delete</div>
            <div class="flex flex-col">
              <div class="lg:hidden text-gray-500">Expires in</div>
              <div class="flex lg:flex-col gap-2 lg:gap-0 items-baseline text-xl lg:text-lg">
                <div class="text-xl lg:text-lg">
                  {{ file.expiry_ts_pretty }}
                </div>
                <div class="text-gray-500 text-sm">
                  {{ file.expiry_ts }}
                </div>
              </div>
            </div>
          </td>
          <td class="flex lg:table-cell flex-row gap-4">
            <div class="lg:hidden matsym text-2xl text-gray-500">download</div>
            <div class="flex flex-col">
              <div class="lg:hidden text-gray-500">Downloads</div>
              <div class="text-xl lg:text-lg lg:text-center">{{ file.downloads }}</div>
            </div>
          </td>
          <td>
            <button type="button" data-efdhash="{{ file.efd_sha256sum }}"
              class="admin-delete-button no-underline w-full lg:w-auto lg:mx-auto flex items-center justify-center gap-4 p-4 rounded-full bg-gray-300 text-xl font-bold cursor-pointer shadow-sm hover:shadow-md active:shadow-sm disabled:shadow-none disabled:text-gray-400 disabled:bg-gray-200 disabled:cursor-not-allowed">
              <span class="matsym no-underline">delete</span>
              <span class="lg:hidden">Delete from Server</span>
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-center text-xl">No files are currently stored on the server. <a class="classic-link" href="/">Upload one!</a></p>
    {% endif %}
  </div>
</div>
<script>
async function delete_handler(btn, event) {
  // Disable the button while the request is being processed.
  btn.disabled = true;

  // Create the new request to the deletion-endpoint.
  let xhr = new XMLHttpRequest();
  xhr.open('POST', '/delete_endpoint');
  xhr.setRequestHeader('Content-Type', 'application/json');

  xhr.onload = () => {
    if (xhr.status === 200) {
      // Successful? Strike through all values in the row. (first five <td>s in it)
      for (let i = 0; i < 5; i++) {
        let item = btn.parentElement.parentElement.childNodes[i];
        item.classList.add("line-through");
        item.classList.add("text-gray-400");
      }
    } else {
      // No fancy interface here, just console.
      console.log(xhr.responseText);
    }
  }

  xhr.send(JSON.stringify({
    hash: btn.dataset.efdhash,
  }))
}

for (btn of document.querySelectorAll(".admin-delete-button")) {
  btn.addEventListener("click", delete_handler.bind(null, btn));
}
</script>
{% endblock %}
